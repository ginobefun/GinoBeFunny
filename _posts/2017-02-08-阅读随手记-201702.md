---
title: 阅读随手记 201702
date: 2017-02-08 12:31:23
tags: [微服务, 架构, 消息中间件, 缓存, RPC, 监控, 高性能, 高并发, 高可用]
categories: Reading Record
link_title: reading_record_201702
---
关键字：微服务, 架构, 消息中间件, 缓存, RPC, 监控, 高性能, 高并发, 高可用。
<!-- more -->

###  [Microservices: A definition of this new architectural term](https://martinfowler.com/articles/microservices.html) Martin Fowler

#### 微服务架构风格
- 一组微型的服务/独立开发/通过轻量级机制通信/自动化的独立部署/各服务之间可采用不同语言和技术方案；
- 很难给微服务下一个具体的定义，Martin Fowler通过九大特性来阐述微服务；


> the microservice architectural style is an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API. These services are built around business capabilities and independently deployable by fully automated deployment machinery. There is a bare minimum of centralized management of these services, which may be written in different programming languages and use different data storage technologies.

#### 微服务的九大特性
##### 1. 组件化与服务
- **组件**（component）是一个可以独立更换和升级的软件单元；
- **软件库）**（libraries是能被链接到程序且通过方法调用的组件；
- **服务**（services）是进程外的组件，通过web service或rpc的机制来通信；
- 使用服务而非软件库的方式来组件化的主要原因是服务可被独立部署（避免一个组件修改导致需要重新部署整个应用），另外一个好处是能获得更加显式的组件接口（想想单体应用中的API依赖）；
- 当然也有不足之处，比如远程调用比进程内的调用要更加昂贵；

##### 2. 围绕业务功能组织团队
- 对一个大型的应用进行分解时，通常是按照技术层面来进行划分，比如分为前端开发、后端开发和数据库开发（当然实际情况比这更细），但是这样会带来一个问题就是一个很小的需求都需要跨团队的项目合作和进度安排；这就是**康威定律**（任何设计系统的组织，都会产生这样一个设计，即该设计的结构与该组织的沟通结构相一致）起作用的例子；
- 而微服务是通过**业务功能**将系统分解为若干服务，这些服务针对该业务领域提供多层次广泛的软件实现；因此团队是**跨职能**的，它拥有软件开发所需的全方位的技能（如用户体验、数据库和项目管理）；
- 大型单体应用系统也可以根据业务功能进行模块化设计，但是通常的问题是一个团队会包含太多的功能，而团队之间的边界也不够清晰；

##### 3. 做产品而非做项目
- 大部分的应用开发都使用这样一个产品模型：一旦某项软件功能已交付，就会将软件移交给维护团队，而开发团队随之被解散；
- 而微服务主张**“一个团队应该拥有该产品的整个生命周期”**（原子亚马逊的“you build, you run it”）这样的理念，即一个开发团队对一个生产环境下运行的软件负全责；
- 这样的产品理念是与业务功能相绑定的，它不会把软件开成是一系列待完成功能的集合，而是一种持续提升客户业务功能的关系；
- 当然，单体应用也可以采用上述的产品理念，但是更细粒度的服务能使服务的开发者和它的用户更近；

##### 4. 智能终端和傻瓜管道
- 在不同的进程进行通信时，多数的产品或方法会在其中加入大量的智能特性，有个典型的例子就是ESB（企业服务总线），它通常包括消息路由、编制、转换和业务规则应用；
- 而微服务主张采用另一种做法：**智能终端**（smart endpoints）和**傻瓜管道**（dumb pipes）。这里的理解是应该尽可能地简化进程间的通信，将一些需要智能处理的逻辑（比如路由、重试等）交给服务处理；
- 微服务最常用的两种协议是：带有资源API的HTTP请求-响应协议和轻量级的消息发送协议（如RabbitMQ、ZeroMQ）；
- 将一个单体应用拆分为微服务的最大挑战就是改变原有的通信模式，如果直接将原先的进程内方法调用改为RPC会导致微服务直接产生繁琐的通信，因此应该考虑更粗粒度的方式调用；

##### 5. 去中心化的治理
- 集中治理的一个问题是会趋向于在单一技术平台上制定标准从而带来局限性；
- 微服务中的**分权治理**（去中心化的）使得每个服务可以选择不同的技术，比如选择不同的语言和数据库；
- 相比于选用一组已定义好的标准，微服务的开发者更喜欢自己编写一些有用的工具，这些工具通常源于他们的微服务实施过程并分享给更多的团队；比如Nteflix就是一个很好的例子，这家提供网络视频点播的公司开源了一系列的实施微服务的工具；
- 对微服务社区来说，像[**容错读取**](https://martinfowler.com/bliki/TolerantReader.html)（Tolerant Reader）和[**消费者驱动的契约**](https://martinfowler.com/articles/consumerDrivenContracts.html)（Consumer-Driven Contracts）的模式已经被用于日常管理；
- 像Netflix这样的公司已经开始推行分权治理，这样可以令程序员更加注重质量（谁都不想半夜被电话叫去修复问题对吧），而这些与之前传统的集中治理有着天壤之别；

##### 6. 去中心化的数据管理
- **去中心化的数据管理**从最抽象的层面看，意味着各个系统对客观世界所构建的概念模型将彼此不同，比如客户的概念对于销售和支撑团队就有所不同；
- 思考这类问题的一个有用的方法就是使用**领域驱动设计**（Domain-Driven Design, DDD）中的[**上下文边界**](http://martinfowler.com/bliki/BoundedContext.html)（Bounded Context）的概念；DDD将一个复杂的领域划分为多个上下文边界，并且将它们的相互关系用图表示出来；
- 不同于单体应用喜欢共用一个单独的数据库（也许是被商业数据库的license逼出来的），微服务更喜欢让每一个服务管理其自有的数据库，可以采用相同数据库技术的不同实例，也可以采用完全不同的数据库系统；
- 但是去中心化的数据管理会带来数据一致性的问题，对此微服务强调的是**无事务的协调**（transactionless coordination between services），这源自微服务社区明确地认识到以下两点：即数据一致性可能只要求数据最终一致性，并且一致性问题能够通过补偿操作来进行处理；

##### 7. 基础设施自动化
- 云的发展已经很大程度上降低了构建、部署和运维微服务的复杂性了；
- 许多使用微服务构建的团队都具备**持续交付**（Continuous Delivery）的经验，这样的团队广泛采用了基础设施自动化的技术，如下图的构建流水线所示：

![构建流水线](http://oi46mo3on.bkt.clouddn.com/15_reading_201702/basic_pipeline.png)

- 持续交付需要大量的**自动化测试**以及**自动化部署的能力**，通过这两个关键特点使得我们能更有信心、更愉快地部署功能到生成环境；另外，微服务的独立性也使得部署更加容易（这里的容易是指只需要部署修改的服务而不需要部署整个应用），当然也会带来困难（原来只需要部署一个系统，而现在需要部署更多的服务），此时就需要在部署工具上投入精力改进；

##### 8. 容错设计
- 使用微服务作为组件，需要设计成能容忍这些服务所出现的故障；一旦某个服务出现故障，其他任何对该服务的调用都会出现故障，客户端需要尽可能优雅地处理这种情况；与单体应用相比，这是微服务引入的额外的复杂性；
- Netflix公司开源的[**Simian Army**](https://github.com/Netflix/SimianArmy)能够诱导服务发生故障来测试应用的弹性和监控能力；
- [**断路器**](http://martinfowler.com/bliki/CircuitBreaker.html)（Circuit Breaker）是一种用于隔离故障的模式，Netflix公司的这篇很精彩的[博客](http://techblog.netflix.com/2012/02/fault-tolerance-in-high-volume.html)解释了这些模式是如何应用的；
- **容错设计**要求能够快速地检测出故障，而且在可能的情况下自动恢复服务；此时**实时监控**就变得非常重要，它可用来检查架构元素指标（比如数据库每秒接收到多少请求）和业务相关指标（如系统每分钟收到多少订单）以便预测故障的发生；这对于微服务来说尤为重要，因为微服务对于服务编排和事件协作的偏好更易导致突发行为；
- 采用微服务的团队通常希望使用仪表盘或者日志记录装置来监控服务的运行和各项指标；

##### 9. 演进式设计
- 每当试图将软件系统拆分为各个组件时，都会面对一个棘手的问题，即如何拆分，拆分的原则是什么？
- 一个组件的关键属性，是具有**独立可替换性和可升级性**（independent replacement and upgradeability），这使得我们在重写一个组件时更多的是聚焦于功能而非与不用担心与其他的关联组件；
- 而事实上，许多做微服务的团队会更进一步，他们明确地预期许多服务将来会报废而不是长期演进；比如英国卫报网站，他们依然使用原先的单体应用作为网站核心，而对于一些新的功能，比如增加报道一个体育赛事的页面，就会采用微服务的方式来添加，一旦赛事结束了，这个服务就可以被废除；
- 这种强调可更换性的特点是模块化设计一般性原则的一个特例，通过**变化模式**（the pattern of change）来驱动进行模块化的实现；将那些能在同时发生变化的东西放到相同的模块中，如果发现需要同时反复变更两个服务是，这就是它们两个需要被合并的一个信号；
- 将一个个组件放入一个个服务中增加了做出更精细化版本发布的机会，对于单体应用，任何变化都需要做一次整个应用系统的全量构建和部署，而对微服务来说，只需要部署修改的服务即可；

#### 微服务是未来的方向吗？
- 作者通过该文阐述了微服务的主要思路和原则，在当时已经有一些公司如亚马逊和Netflix提供了正面的经验，收到了不少正面的评价；
- 架构决策所产生的真正效果通常需要若干年后才能真正显现，当时考虑的限制微服务的因素主要有组件拆分的难度、组件直接的复杂关联关系以及团队技能，但从目前的发展来看，已经有越来越多的企业采用了微服务的架构；


###  [Microservices: Decomposing Applications for Deployability and Scalability](https://www.infoq.com/articles/microservices-intro)  Chris Richardson



###  [Pattern: Microservice Architecture](http://microservices.io/patterns/microservices.html) Chris Richardson



###  [Introduction to Microservices](https://www.nginx.com/blog/introduction-to-microservices/) Chris Richardson



###  [Building Microservices: Using an API Gateway](https://www.nginx.com/blog/building-microservices-using-an-api-gateway/) Chris Richardson



###  [Building Microservices: Inter-Process Communication in a Microservices Architecture](https://www.nginx.com/blog/building-microservices-inter-process-communication) Chris Richardson



###  [Service Discovery in a Microservices Architecture](https://www.nginx.com/blog/service-discovery-in-a-microservices-architecture/) Chris Richardson



###  [Event-Driven Data Management for Microservices](https://www.nginx.com/blog/event-driven-data-management-microservices/) Chris Richardson



###  [Choosing a Microservices Deployment Strategy](https://www.nginx.com/blog/deploying-microservices/) Chris Richardson



###  [Refactoring a Monolith into Microservices](https://www.nginx.com/blog/refactoring-a-monolith-into-microservices/) Chris Richardson


### [Fault Tolerance in a High Volume, Distributed System](http://techblog.netflix.com/2012/02/fault-tolerance-in-high-volume.html) Ben Christensen




