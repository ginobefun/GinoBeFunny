---
title: 阅读随手记-201704
date: 2017-04-08 13:25:52
tags: [微服务, 架构, Elasticsearch]
categories: Reading Record
link_title: reading_record_201704
---
关键字：微服务, 架构, Elasticsearch。
<!-- more -->

### [Elasticsearch前沿：ES 5.x改进详解与ES6展望](https://mp.weixin.qq.com/s/yVbZfE7oWGmnfmcFTeSV4w)  曾勇

- 如果你的场景是日志，那么基本上数据进去之后是不需要进行修改的，所以现在ES新增了一个append-only的索引模式，也就是当ES是自动生成ID的时候，ES可以跳过不必要的版本检测，**大概可以提升20%左右的索引性能**。
- 在数据结构方面，新增了多个range字段类型，现在你可以计算连续数据的交并集，可以是时间范围，也可以是数值范围。
- 下一个特性值得介绍的就是**_all 字段的移除**，去掉_all字段之后，磁盘占用少了不少，索引性能也有一些提升。
- 现在有一个新的高亮器：Unified Highlighter，大家可能会问，目前ES默认已经提供了3种不同的高亮器，为什么还会有一个新的轮子呢，因为之前的用法有点复杂, 用户选择起来比较困难，新的unified highlighter目的就是简化高亮的使用，可以支持前面3种高亮类型的自动选择。
- 还有一个是keyword类型可以通过normalizer来进行标准化了，keyword类型相比text类型就是不能分词，但是可能同样需要进行相应的标准化处理，比如统一转成小写，移除标点符号等等，使用方式和analyzer一样。
- 另一个就是Multi-Word Synonyms，之前是不支持同义词中间有空格分割的，分词的时候会帮你切分开，搜索的时候不能正确处理词组这种同义词。
- 同义词现在可以支持词组了，也就是说同义词如果是由多个词组成的，不会在分词的时候被傻傻的拆开，而是正确的处理。
- 还一个就是字段折叠（ Field collapsing），这个特性比较有意思，你可以在搜索的时候，按某个字段作为维度进行去重，我这里写过一篇详细的博客，有兴趣的可以去看看：http://elasticsearch.cn/article/132
- ES的搜索，对于一些耗时较长的查询，现在可以通过ES的任务管理机制来进行取消了，感兴趣的可以查看文档：https://www.elastic.co/guide/en/elasticsearch/reference/5.3/search.html#global-search-cancellation
- 现在term aggs提供了一种分区的概念，你可以对一个字段，分n次进行聚合，分而治之，有兴趣的可以看看文档：https://www.elastic.co/guide/en/elasticsearch/reference/5.3/search-aggregations-bucket-terms-aggregation.html#_filtering_values_with_partitions
- 当你的集群变红的时候，新增的 /_cluster/allocation/explain 接口能够直接告诉你哪里出了问题；
- Java REST Client也有了更新，ES之前提供了一个偏底层的Java HTTP REST client，但是用起来太费劲，需要手动拼 JSON，现在Java REST Client分成了Java High Level REST Client和Java Low Level REST Client， High Level基于Low Level来实现，顾名思义，提供更多用户方便的接口调用，High Level REST Client将提供和Transport Client类似的接口，不用手动去拼接QueryDSL的JSON了，目测在 5.5 版本提供。
- 以前的搜索的reduce操作都是要等到把每个分片的结果都拿到本地之后再做合并，现在新增的batched search reduce phases提供了分批进行reduce的行为，也就是不用全部拿到之后再做reduce，而是拿到足够的分配（默认512）之后就开始做reduce，然后拿到合并结果，释放相关的资源。
- ES 6.0展望：稀疏性Doc Values的支持；Index sorting，即在索引阶段的排序，即我们查询的时候有时候会根据某个字段的值进行排序，比如时间、编号等等；顺序号的支持，每个es的操作都有一个顺序编号，这个属于es内部的一个功能，可以提供快速的分片副本恢复或同步、跨数据中心的节点恢复、甚至提供一个Changes API 等；无缝滚动升级，使之能够从5的最后一个版本滚动升级到6的最后一个版本，不需要集群的完整重启。

### [Elasticsearch 5.x 字段折叠的使用](http://elasticsearch.cn/article/132) medcl

- 什么是字段折叠，可以理解就是按特定字段进行合并去重，比如我们有一个菜谱搜索，我希望按菜谱的“菜系”字段进行折叠，即返回结果每个菜系都返回一个结果，也就是按菜系去重，我搜索关键字“鱼”，要去返回的结果里面各种菜系都有，有湘菜，有粤菜，有中餐，有西餐，别全是湘菜，就是这个意思，通过按特定字段折叠之后，来丰富搜索结果的多样性。
- 有人肯定会想到，使用term agg+ top hits agg来实现啊，这种组合两种聚和的方式可以实现上面的功能，不过也有一些局限性，比如，不能分页、结果不够精确以及数据量大的情况下聚合比较慢。
- 而新的的字段折叠的方式是怎么实现的的呢，有这些要点：折叠+取inner_hits分两阶段执行，所以top hits永远是精确的；字段折叠只在top hits层执行，不需要每次都在完整的结果集上对为每个折叠主键计算实际的doc values值，和term agg 相比要节省很多内存；因为只在top hits上进行折叠，所以相比组合聚合的方式，速度要快很多；折叠top docs不需要使用全局序列来转换string，相比agg这也节省了很多内存；分页成为可能，和常规搜索一样，具有相同的局限，先获取from+size的内容，再合并；search_after和scroll暂未实现，不过具备可行性；折叠只影响搜索结果，不影响聚合，搜索结果的total是所有的命中纪录数，去重的结果数未知（无法计算）。
- 来个例子：


    PUT recipes
    POST recipes/type/_mapping
    {
      "properties": {
        "name":{
          "type": "text"
        },
        "rating":{
          "type": "float"
        },"type":{
          "type": "keyword"
        }
      }
    }
    
    
    POST recipes/type/
    {
      "name":"清蒸鱼头","rating":1,"type":"湘菜"
    }
    POST recipes/type/
    {
      "name":"剁椒鱼头","rating":2,"type":"湘菜"
    }
    POST recipes/type/
    {
      "name":"红烧鲫鱼","rating":3,"type":"湘菜"
    }
    POST recipes/type/
    {
      "name":"鲫鱼汤（辣）","rating":3,"type":"湘菜"
    }
    POST recipes/type/
    {
      "name":"鲫鱼汤（微辣）","rating":4,"type":"湘菜"
    }
    POST recipes/type/
    {
      "name":"鲫鱼汤（变态辣）","rating":5,"type":"湘菜"
    }
    POST recipes/type/
    {
      "name":"广式鲫鱼汤","rating":5,"type":"粤菜"
    }
    POST recipes/type/
    {
      "name":"鱼香肉丝","rating":2,"type":"川菜"
    }
    POST recipes/type/
    {
      "name":"奶油鲍鱼汤","rating":2,"type":"西菜"
    } 

    GET recipes/type/_search
    {
      "query": {
        "match": {
          "name": "鱼"
        }
      },
      "collapse": {
        "field": "type",
        "inner_hits": {
          "name": "top_rated",
          "size": 2,
          "sort": [
            {
              "rating": "desc"
            }
          ]
        }
      },
      "sort": [
        {
          "rating": {
            "order": "desc"
          }
        }
      ],
      "size": 2,
      "from": 0
    }

### [如何做出搜索和推荐深度融合的兴趣引擎架构](https://mp.weixin.qq.com/s/7DOj5Hed3Q4Crr8ng4TeBw) 田明军

### [携程实时用户行为系统实践](https://mp.weixin.qq.com/s/OJdlpP62YWGmVnBWsfpVZw)  陈清渠


### [Spark技术在京东智能供应链预测的应用](https://mp.weixin.qq.com/s/FK4rjuWyI6S6IZ4pAdMc4g) 杨冬越 郭景瞻


### [对CQRS的基础理解](https://mp.weixin.qq.com/s/S2UGCS00gWzr-nuAapR96g) 张逸

- CQRS即Command Query Responsibility Seperation（命令查询职责分离），其设计思想来源于Mayer提出的CQS（Command Query Seperation）。这种命令与查询的分离方式，可以更好地控制请求者的操作。查询操作不会造成数据的修改，因而它属于一种幂等操作，可以反复地发起，而不用担心会对系统造成影响。基于这种特性，我们还可以为其提供缓存，从而改进查询的性能。命令操作则与之相反，它会直接影响系统信息的改变。
- 查询操作与命令操作对事务的要求也不一样。由于查询操作不会改变系统状态，因而，不会产生最终的数据不一致。从请求响应的角度来看，查询操作常常需要同步请求，实时返回结果；命令操作则不然，因为我们并不期待命令操作必须返回结果，这就可以采用fire-and-forget方式，而这种方式正是运用异步操作的前提。此外，对于大多数软件系统而言，查询操作发起的频率通常要远远高于命令操作。如上种种，都是将命令与查询进行分离的根本原因。
- 下图是CQRS框架AxonFramework官方文档给出的CQRS架构图。在这个架构图中，最核心的概念是Command、Event。以我的理解，CQRS模式的风格源头就是基于事件的异步状态机模型。抛开命令查询分离这一核心原则，这才是CQRS的基础内容。

![CQRS架构图](http://oi46mo3on.bkt.clouddn.com/18_reading_201704/cqrs-arch.png)

- CQRS对设计者的影响，是将领域逻辑，尤其是业务流程，皆看做是一种领域对象状态迁移的过程。这一点与REST将HTTP应用协议看做是应用状态迁移的引擎，有着异曲同工之妙。这种观点（或设计视图）引出了Command与Event的概念。Command是系统中会引起状态变化的活动，通常是一种命令语气，例如注册会议RegisterToConference。至于Event，则描述了某种事件的发生，通常是命令的结果（但并不一定是直接结果，但源头一定是因为发送了命令），例如OrderConfirmed。


### [我对CQRS/EventSourcing架构的思考](https://mp.weixin.qq.com/s/uZPzDopFApOHTXzwEbfluQ) 汤雪华

- **聚合**，它通过定义对象之间清晰的所属关系和边界来实现领域模型的内聚，并避免了错综复杂的难以维护的对象关系网的形成。聚合定义了一组具有内聚关系的相关对象的集合，我们把聚合看作是一个修改数据的最小原子单元。

![聚示意图](http://oi46mo3on.bkt.clouddn.com/18_reading_201704/DDD_Aggregation_Example.png)

- **聚合根**：每个聚合都有一个根对象，根对象管理聚合内的其他子对象（实体、值对象），聚合之间的交互都是通过聚合根来交互，不能绕过聚合根去直接和聚合下的子实体进行交互。
- **Eventual Consistency**：聚合内的数据修改，是ACID强一致性的；跨聚合的数据修改，是最终一致性的。遵守这个原则，可以让我们最大化的降低并发冲突，从而最大化的提高整个系统的吞吐。
- **In Memory**：指整个系统中的所有的聚合根对象都活在内存。在In-Memory的架构下，当要修改某个聚合根的状态时，它已经在内存，我们可以直接拿到该对象的引用，且框架会尽量保证聚合根对象的状态就是最新的。聚合根是在内存中的最小计算单元，每个聚合内部都封装了业务规则，并保证数据的强一致性。
- **Event Sourcing**：不保存对象的最新状态，而是保存对象产生的所有事件；通过事件溯源得到对象最新状态。
- **Event Sourcing VS CRUD**：对于CRUD，DB的记录可变，可以增删改；对于ES，没有更新、删除，只有Append Event，不可变。
- **Actor Model**：其核心思想是对象直接不会直接调用来通信，而是通过发消息来通信。每个Actor都有一个Mailbox，它收到的所有的消息都会先放入Mailbox中，然后Actor内部单线程处理Mailbox中的消息。从而保证对同一个Actor的任何消息的处理，都是线性的，无并发冲突。从全局上来看，就是整个系统中，有很多的Actor，每个Actor都在处理自己Mailbox中的消息，Actor之间通过发消息来通信。Akka框架就是实现Actor模型的并行开发框架，并且Akka框架融入了聚合、In-Memory、Event Sourcing这些概念。Actor非常适合作为DDD聚合根。Actor的状态修改是由事件驱动的，事件被持久化起来，然后通过Event Sourcing的技术，还原特定Actor的最新状态到内存。

![Actor Model](http://oi46mo3on.bkt.clouddn.com/18_reading_201704/Actor_Model.jpg)

- 下图是**CQRS架构的典型架构图**。CQRS架构的核心出发点是将整个系统的架构分割为读和写两部分，从而方便我们对读写两端进行分开优化；CQRS架构的一致性模型为最终一致性。采用CQRS架构的一个前提是，你的系统要接受系统使用者查询到的数据可能不是最新的，而是有几个毫秒的延迟。

![CQRS架构](http://oi46mo3on.bkt.clouddn.com/18_reading_201704/CQRS_ES_Arch.jpg)

- **CQRS架构的适用场景**：当我们的应用的写模型和读模型差别比较大时；当我们希望实践DDD时，因为CQRS架构可以让我们实现领域模型不受任何ORM框架带来的对象和数据库的阻抗失衡的影响；当我们希望对系统的查询性能和写入性能分开进行优化时，尤其是读/写比非常高的系统，CQ分离是必须的；当我们希望我们的系统同时满足高并发的写、高并发的读的时候；因为CQRS架构可以做到C端最大化的写，Q端非常方便的提供可扩展的读模型。
- **C端的命令执行流程**：发送命令到分布式MQ；然后命令的订阅者处理命令；订阅者内部根据不同的命令调用不同的Command Handler进行处理；Command Handler内部根据命令所指定的聚合根ID从In-Memory内存中直接获取聚合根对象的引用，然后操作聚合根对象；聚合根对象状态发生变化并产生事件；框架负责自动持久化事件到Event Storage；框架负责将事件发布到Event MQ；Event订阅者订阅事件，然后调用对应的Event Handler进行处理，如更新Data Storage；
- **Q端的查询执行流程**：调用轻薄的Query Service，传如Query DTO；Query Service从读库进行查询并返回结果；
- 挖掘出**更多有用的特性**：一个命令只允许修改一个聚合根；命令或事件在分布式MQ的路由根据聚合根ID来路由，也就是同一个聚合根的命令和事件都在一个队列里；引入Command Mailbox，Event Mailbox这两个概念，将聚合根需要处理的命令和产生的事件都队列化去并发，做到架构上最大的并行，将并发降低到最低；引入Group Commit技术，做到整个C端的架构层面支持批量提交聚合根产生的事件，从而极大的提高C端的整体吞吐量；通过引入Saga的概念，做到基于事件驱动的最终一致性；
- **Event Sourcing的优点**：记录了数据完整变化过程，最详细的日志；可以将系统还原到任何一个时间点的状态；Domain Event非常有业务价值，BI分析事件能预测业务未来发展情况；可以有效解决线上的数据问题，线下重演一遍，就能知道哪里出问题；不再需要用到ORM，所以没有O/R阻抗失衡的问题，领域模型的设计可以更OO；将Command、Event串联起来，可以分析聚合根的整个变化过程，有助于排查分析问题；自动并发冲突检测、命令的幂等处理；
- **Event Sourcing的缺点**：事件数量巨大，如何存储；如果单个聚合根事件过多，则重演会造成性能问题；领域模型重构被制约，事件的修改必须兼容以前的结构；数据库订正不在有效；架构实践门槛高，没有成熟框架支撑基本无望；需要具备DDD领域建模的能力；事件驱动状态的修改，思维转变难。


### [北大AI公开课第6讲 王俊：DNA是生命数字化的过程，AI改变生命科学](https://mp.weixin.qq.com/s/h7IhHK1vfrHQYDpFLVZ7yA) 新智元

视频回放链接：http://www.iqiyi.com/l_19rrfgal1z.html

### [北大AI公开课第7讲 徐伟：AGI 2050年前实现可能性超50%](https://mp.weixin.qq.com/s/mBfXDpqabIFdksCYTixcaw) 机器学习研究会 

视频回放链接：http://www.iqiyi.com/l_19rrbkb3az.html

### [北大AI公开课第8讲 李航：自然语言处理——理想与现实、机遇与挑战](https://mp.weixin.qq.com/s/Kxu_4QUdWQrjue9W1TvfDg)  机器学习研究会


### [机器学习演化史，方法、应用场景与发展趋势](https://mp.weixin.qq.com/s/B4RV1iO9fciguqP9J1hCxQ)  新智元


### [关于微服务的发展方向，我们和5位专家聊了聊](https://mp.weixin.qq.com/s/F4SLNmCs7iIkZe9nxnXDdA) Mark Little/薛命灯 


### [kafka数据可靠性深度解读](https://mp.weixin.qq.com/s/ExzSzf0ue7d-_Qv8q6p9bw) 朱忠华



### [去哪儿网机票搜索系统的高并发架构设计](https://mp.weixin.qq.com/s/1ipdByfsaTcHpo_W5gJVug) 蒋志伟



### [聊聊分布式定时任务中间件架构及其实现](https://mp.weixin.qq.com/s/pqOujhOQlxw6XR_e7MP02w) 张亮



### [2017年会是Serverless爆发之年吗？](https://mp.weixin.qq.com/s/vQ22_disiOIbfOHz95Ls-w) 麦克周



### [Java 9新特性介绍及Jigsaw一览](http://2017.qconbeijing.com/) QCON/杨晓峰


### [打造高性能高可用的搜索服务——爱奇艺搜索架构实践](http://2017.qconbeijing.com/) QCON/陈爱云


### [高速发展业务的架构应对实践](http://2017.qconbeijing.com/) QCON/陈霖


### [美团点评旅游推荐系统的演进](http://2017.qconbeijing.com/) QCON/郑刚


### [深度学习在电子商务中的应用](http://2017.qconbeijing.com/) QCON/程进兴


### [微信红包后台系统可用性设计实践](http://2017.qconbeijing.com/) QCON/michaelfang


### [异步场景下的全栈溯源](http://2017.qconbeijing.com/) QCON/杨金全


### [异构系统链路追踪——滴滴 trace 实践](http://2017.qconbeijing.com/) QCON




### [任何人都能看懂的TensorFlow介绍](https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&mid=2650718466&idx=1&sn=016f111001e8354d49dd4ce279d283cd) Soon Hin Khor/机器之心


### [小白也能看懂的TensorFlow介绍](https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&mid=2650723520&idx=1&sn=d204284574e9e56682b6ed6f9dcaff01) Soon Hin Khor/机器之心


### [Leaf——美团点评分布式ID生成系统](http://tech.meituan.com/MT_Leaf.html) 照东


### [DevOps详解](http://www.infoq.com/cn/articles/detail-analysis-of-devops)  Jerome Kehrli/大愚若智



### [在Elasticsearch中应用机器学习排序LTR](http://www.infoq.com/cn/articles/we-are-bringing-learning-to-rank-to-elasticsearch)  OpenSource Connections/杨振涛



### [LTR在个性化电商搜索领域的应用](http://www.infoq.com/cn/presentations/learning-to-rank-in-the-field-of-personalized-electric-business-search)  吴晨







